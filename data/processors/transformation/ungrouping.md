# ![Разгруппировка](../../images/icons/components/ungroup-data_default.svg) Разгруппировка

Компонент выполняет действие обратное [агрегации по сумме](../func/aggregation-functions.md), применяемой в [Группировке](./grouping.md). Для определения групп, по которым будет производиться обратная агрегация численного поля, требуется опорная таблица, из которой заимствуются сами группы и учитывается процентное распределение значений численного поля между ними.

Область основного применения разгруппировки — это детализация спрогнозированных данных на основе уже имеющихся. Например, если имеются данные о суммах совершенных продаж конкретных товаров, эти данные можно использовать для разгруппировки по товарам таблицы прогноза, сделанного только для товарных групп.

%spoiler%Пример:%spoiler%

Допустим, у нас есть прогноз сумм продаж, составленный для двух товарных групп, и нам нужно выявить из этого прогноза суммы продаж для отдельных товаров.

Разгруппируемые данные:

| Группа товаров | Сумма продаж, тыс. руб. |
| :------------- | ----------------------: |
| Товары для дачи | 42,00 |
| Товары для дома | 5,00 |

В качестве опорных данных будем использовать данные о суммах продаж за предыдущий период.

Данные для расчета долей:

| Группа товаров | Название товара | Сумма продаж, тыс. руб. |
| :------------- | :-------------- | ----------------------: |
| Товары для дачи | Кресло плетеное | 16,00 |
| Товары для дачи | Лопата совковая | 23,50 |
| Товары для дома | Сахарница расписная | 5,70 |
| Товары для дома | Графин стеклянный | 4,20 |
| Товары для дачи | Термос стальной | 7,60 |
| Товары для дачи | Семена тюльпанов красных | 5,30 |
| Товары для дачи | Жидкость для розжига | 6,20 |
| Товары для дома | Розовая шипучка | 1,60 |
| Товары для дома | Мыло детское | 2,90 |

При настройке узла разгруппировки выберем метод *С расчетом долей по всей выборке*, выставим округление до одного знака после запятой и *Пропорциональный* метод балансировки. В области настройки назначений полей свяжем поля `Группа товаров` обеих таблиц, полю `Сумма продаж, тыс. руб.` из разгруппируемой таблицы выставим назначение *Разгруппируемое*, а полям `Название товара` и `Сумма продаж, тыс. руб.` из опорной таблицы — назначения *Поле с наименованиями* и *Поле с долями* соответственно.

Выход разгруппировки:

| Группа товаров | Название товара | Сумма продаж группы, тыс. руб. | Сумма продаж группы, тыс. руб. &#124; Округлено | Разгруппированное значение |
| :------------- | :-------------- | -----------------------------: | -----------------------------------------: | -------------------------: |
| Товары для дачи | Кресло плетеное | 42,00 | 42,00 | 11,50 |
| Товары для дачи | Лопата совковая | 42,00 | 42,00 | 16,90 |
| Товары для дачи | Термос стальной | 42,00 | 42,00 | 5,40 |
| Товары для дачи | Семена тюльпанов красных | 42,00 | 42,00 | 3,80 |
| Товары для дачи | Жидкость для розжига | 42,00 | 42,00 | 4,40 |
| Товары для дома | Сахарница расписная | 5,00 | 5,00 | 1,90 |
| Товары для дома | Графин стеклянный | 5,00 | 5,00 | 1,50 |
| Товары для дома | Розовая шипучка | 5,00 | 5,00 | 0,60 |
| Товары для дома | Мыло детское | 5,00 | 5,00 | 1,00 |

* **Сумма продаж группы, тыс. руб.** — сумма продаж для конкретный группы;
* **Сумма продаж группы, тыс. руб. | Округлено** — в этом поле выводятся значения, получаемые при применении округления;
* **Разгруппированное значение** — в текущем примере это детализация продаж товаров, измеряемая в тыс. руб.

%/spoiler%

## Ports

### Вход

* ![Разгруппируемые данные](../../images/icons/app/node/ports/inputs/table_inactive.svg) **Разгруппируемые данные** — таблица, содержащая поле для разгруппировки;
* ![Данные для расчета долей](../../images/icons/app/node/ports/inputs/table_inactive.svg) **Данные для расчета долей** — таблица, из которой считываются значения долей для разгруппировки.

### Выход

* ![Выход разгруппировки](../../images/icons/app/node/ports/inputs/table_inactive.svg) **Выход разгруппировки** — исходная таблица после обработки, в нее добавляются следующие поля.
   * **Метка поля|Округлено** — поле содержит округленные разгруппируемые значения (в случае применения округления).
   * **Разгруппированное значение** — поле содержит значения разгруппированные согласно *Методу разгруппировки*.

Если применяется *Метод разгруппировки: С учетом временных колебаний и сезонности опорных данных*, то в эту таблицу добавляются также следующие поля:

* **Верхняя граница 95% ДИ** — верхняя граница 95%-го [доверительного интервала](https://wiki.loginom.ru/articles/confidence-interval.html).
* **Нижняя граница 95% ДИ** — нижняя граница 95%-го доверительного интервала.
* **Значение тренда** — значение тренда в данной точке для данной позиции.
* **Значение сезонного индекса** — коэффициент, характеризующий [сезонность](https://wiki.loginom.ru/articles/seasonal-component.html) для данной точки и данной позиции.
* **Код типа значения** — в зависимости от итогов разгруппировки, может принимать значение от 0 до 6.
* **Тип значения** — содержит пояснения к каждому коду типа значения, где.
   * **0** — нормально разгруппированное значение.
   * **1** — разгруппированное значение, которое изначально было задано как фиксированное, но фиксация была снята алгоритмом.
   * **2** — зафиксированное пользователем значение.
   * **3** — значение, зафиксированное пользователем, но несогласованное с опорной выборкой.
   * **4** — значение, зафиксированное алгоритмом в ходе расчетов.
   * **5** — ошибочное значение.
   * **6** — исключено из обработки.
* ![Показатели качества модели и сезонные индексы](../../images/icons/app/node/ports/inputs/table_inactive.svg) **Показатели качества модели и сезонные индексы** — справочная таблица, составляется только при использовании метода *с учетом временных колебаний и сезонности опорных данных*, содержит поля.
   * **Индекс качества разгруппировки** — принимает значения от 0 (очень плохое качество, результатам нельзя доверять) до 1 ("идеальное" качество, опорная выборка не содержит шума, а разгруппированные значения точно укладываются в прогноз).
   * **Сезонный индекс (1, 2, 3, ...)** — количество полей с сезонными индексами указывается в мастере настройки.

## Wizard

* **Метод разгруппировки** — в выпадающем списке выбирается один из трех методов разгруппировки.
   * **По заданным долям** — метод применяется, когда доли для разгруппировки уже присутствуют в опорной таблице, в типичном случае сумма долей должна быть равна единице, но это условие не является обязательным.
   * **С расчетом долей по всей выборке** — процентное соотношение долей для разгруппировки будет таким же, как и у значений поля опорной таблицы, выбранного для расчета долей.
   * **С учетом временных колебаний и сезонности опорных данных** — применяется для разгруппировки временного ряда данных.
* **Формат округления** — указывается используемый для округления формат.
   * **Не округлять** — данные не округляются при обработке.
   * **Округлять до кратного целому** — округление разгруппированных значений до чисел, кратных заданному целому числу.
   * **Округлять до заданной точности** — округление разгруппированных значений до указанного количества цифр после запятой.
* **Метод балансировки** — подсчитывается разница между округленным разгруппируемым значением и фактической суммой округленных разгруппированных. После этого разница распределяется между всеми разгруппированными значениями в соответствии с выбранным методом балансировки.
   * **Нет балансировки** — распределения разницы не производится.
   * **Все последнему** — прибавляется к последнему разгруппированному значению.
   * **Пропорционально** — разница распределяется частями, пропорциональными величине разгруппированных значений.
   * **Равномерно** — распределяется между разгруппированными значениями поровну.
* **Область настройки назначений полей** — представляет собой две таблицы, в первой находится перечень полей разгруппируемых данных, во второй — перечень полей данных для расчета долей. Возможные варианты назначения полей.
   * ![Группа](../../images/icons/usage-types/group_default.svg) **Группа** — такое назначение выставляется автоматически при связывании полей групп. Связывать следует поля групп, одинаковые для обеих таблиц — для этого достаточно перетащить метку поля из одной таблицы на соответствующую метку поля из другой таблицы, если образованная при этом связь ошибочна, удалить ее можно нажатием на расположенную на ней кнопку ![Удалить](../../images/icons/link-grid/remove-link_hover.svg).
   * ![Разгруппируемое](../../images/icons/usage-types/value_default.svg) **Разгруппируемое** — назначение выставляется полю таблицы разгруппируемых данных, к которому и будет применена разгруппировка.
   * ![Поле с наименование](../../images/icons/usage-types/active_default.svg) **Поле с наименованиями** — выставляется полю опорной таблицы, содержащему наименования, по которым будет производиться разгруппировка.
   * ![Поле с долями](../../images/icons/usage-types/source_default.svg) **Поле с долями** — выставляется полю опорной таблицы, содержащему доли или значения для расчета долей.
   * ![Порядковое поле](../../images/icons/usage-types/transaction_default.svg) **Порядковое поле** — данное назначение доступно только для полей типа *Дата/время* при использовании метода *с учетом временных колебаний и сезонности опорных данных*.

**Настройка порядка следования данных** — этот шаг мастера добавляется при использовании метода *с учетом временных колебаний и сезонности опорных данных*, настройки следующие:

* Сезонность.
   * **Период сезонности** — выбор длины периода сезонности, если задать пункт *нет сезонности*, откроются опции для настройки прогноза по числу точек временного ряда, а настройки по числу периодов заблокируются.
   * **Количество рассчитываемых сезонных индексов** — в таблицу выходного порта *Показатели качества модели и сезонные индексы* для каждого индекса будет добавлено поле.
* Разгруппируемый ряд.
   * **Плотность точек редких товаров** — коэффициент может принимать значения от 0,01 до 1, чем он выше, тем больше позиций будет распознано алгоритмом в качестве слишком редких и они будут исключены из прогноза.
   * **Периодов отсутствия для прекращения позиции** — если позиция отсутствует в ряду указанное число периодов, то она исключается из прогноза.
   * **Точек отсутствия для прекращения позиции** — если позиция отсутствует в ряду указанное число точек, то она исключается из прогноза.
   * **Периодов присутствия для новой позиции** — позиции, встречающиеся не чаще указанного числа периодов, будут считаться новыми.
* Глубина истории.
   * **Максимальное число периодов сезонности** — для построения прогноза будет использовано указанное число последних периодов опорных данных, если задать значение `0`, будут использованы все периоды.
   * **Максимальное число точек каждого ряда** — для построения прогноза будет использовано указанное число последних точек ряда опорных данных, если задать значение `0`, будут использованы все точки.
